"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel —Ñ–∞–π–ª–∞–º–∏ (XLSX) –≤ Yo Store
"""

import pandas as pd
import openpyxl
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
from openpyxl.utils.dataframe import dataframe_to_rows
from typing import List, Dict, Any, Optional
import json
from datetime import datetime
import io

class ExcelHandler:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel —Ñ–∞–π–ª–∞–º–∏"""
    
    def __init__(self):
        self.product_columns = [
            'sku', 'name', 'description', 'level0', 'level1', 'level2', 'brand', 
            'price', 'currency', 'stock', 'image_url', 'specifications'
        ]
        
        self.price_columns = [
            'sku', 'name', 'price', 'old_price', 'currency'
        ]
    
    def create_products_template(self) -> bytes:
        """–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω Excel —Ñ–∞–π–ª–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤"""
        wb = Workbook()
        ws = wb.active
        ws.title = "–¢–æ–≤–∞—Ä—ã"
        
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏
        headers = [
            'SKU —Ç–æ–≤–∞—Ä–∞', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞*', '–û–ø–∏—Å–∞–Ω–∏–µ', '–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (level0)*', '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (level1)*', '–î–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (level2)*', '–ë—Ä–µ–Ω–¥',
            '–¶–µ–Ω–∞*', '–í–∞–ª—é—Ç–∞', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ', 'URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)', '–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (JSON)'
        ]
        
        # –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = Font(bold=True, color="FFFFFF")
            cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
            cell.alignment = Alignment(horizontal="center", vertical="center")
        
        # –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö
        examples = [
            ['IPHONE16Pro-256GB-TitaniumNatural', 'iPhone 16 Pro 256GB Titanium Natural', '–ù–æ–≤–µ–π—à–∏–π iPhone —Å —Ç–∏—Ç–∞–Ω–æ–≤—ã–º –∫–æ—Ä–ø—É—Å–æ–º', '–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã', '16 Series', '16 Pro', 'Apple', 
             89990, 'RUB', 10, '/static/images/products/iphone16pro/titanium-natural/1.jpg, /static/images/products/iphone16pro/titanium-natural/2.jpg', '{"color": "Titanium Natural", "disk": "256GB", "sim_config": "Dual SIM"}'],
            ['MACBOOKAIRM2-512GB-Silver', 'MacBook Air M2 512GB Silver', '–õ–µ–≥–∫–∏–π –∏ –º–æ—â–Ω—ã–π –Ω–æ—É—Ç–±—É–∫', '–ù–æ—É—Ç–±—É–∫–∏', 'Air Series', 'Air M2', 'Apple', 
             149990, 'RUB', 5, '/static/images/products/macbookairm2/silver/1.jpg, /static/images/products/macbookairm2/silver/2.jpg', '{"color": "Silver", "ram": "16GB", "disk": "512GB"}']
        ]
        
        for row, example in enumerate(examples, 2):
            for col, value in enumerate(example, 1):
                ws.cell(row=row, column=col, value=value)
        
        # –î–æ–±–∞–≤–∏—Ç—å –ª–∏—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        images_ws = wb.create_sheet("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
        images_headers = [
            '–ú–æ–¥–µ–ª—å (level_2)*', '–¶–≤–µ—Ç*', 'URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)*'
        ]
        
        # –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        for col, header in enumerate(images_headers, 1):
            cell = images_ws.cell(row=1, column=col, value=header)
            cell.font = Font(bold=True, color="FFFFFF")
            cell.fill = PatternFill(start_color="27ae60", end_color="27ae60", fill_type="solid")
            cell.alignment = Alignment(horizontal="center", vertical="center")
        
        # –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        images_examples = [
            ['iPhone 16 Pro', 'Titanium Natural', '/static/images/products/iphone16pro/titanium-natural/1.jpg, /static/images/products/iphone16pro/titanium-natural/2.jpg, /static/images/products/iphone16pro/titanium-natural/3.jpg'],
            ['iPhone 16 Pro', 'Titanium Black', '/static/images/products/iphone16pro/titanium-black/1.jpg, /static/images/products/iphone16pro/titanium-black/2.jpg, /static/images/products/iphone16pro/titanium-black/3.jpg'],
            ['MacBook Air M2', 'Silver', '/static/images/products/macbookairm2/silver/1.jpg, /static/images/products/macbookairm2/silver/2.jpg, /static/images/products/macbookairm2/silver/3.jpg'],
            ['MacBook Air M2', 'Space Gray', '/static/images/products/macbookairm2/space-gray/1.jpg, /static/images/products/macbookairm2/space-gray/2.jpg, /static/images/products/macbookairm2/space-gray/3.jpg']
        ]
        
        for row, example in enumerate(images_examples, 2):
            for col, value in enumerate(example, 1):
                images_ws.cell(row=row, column=col, value=value)
        
        # –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        for column in images_ws.columns:
            max_length = 0
            column_letter = column[0].column_letter
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = min(max_length + 2, 80)
            images_ws.column_dimensions[column_letter].width = adjusted_width
        
        # –î–æ–±–∞–≤–∏—Ç—å –ª–∏—Å—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
        categories_ws = wb.create_sheet("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏")
        categories_ws.append(['ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–û–ø–∏—Å–∞–Ω–∏–µ', '–ò–∫–æ–Ω–∫–∞'])
        
        categories_data = [
            [1, '–¢–µ–ª–µ—Ñ–æ–Ω—ã', '–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã –∏ –º–æ–±–∏–ª—å–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã', 'üì±'],
            [2, '–ù–æ—É—Ç–±—É–∫–∏', '–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã', 'üíª'],
            [3, '–ò–≥—Ä–æ–≤—ã–µ –ø—Ä–∏—Å—Ç–∞–≤–∫–∏', '–ò–≥—Ä–æ–≤—ã–µ –∫–æ–Ω—Å–æ–ª–∏', 'üéÆ'],
            [4, '–ù–∞—É—à–Ω–∏–∫–∏', '–ê—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', 'üéß'],
            [5, '–ü–ª–∞–Ω—à–µ—Ç—ã', '–ü–ª–∞–Ω—à–µ—Ç–Ω—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã', 'üì±'],
            [6, '–£–º–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏', '–ì–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–º–æ—â–Ω–∏–∫–∏', 'üîä'],
            [7, '–¢–µ–ª–µ–≤–∏–∑–æ—Ä—ã', '–¢–µ–ª–µ–≤–∏–∑–∏–æ–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏', 'üì∫'],
            [8, '–£–º–Ω—ã–µ —á–∞—Å—ã', '–ù–æ—Å–∏–º—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', '‚åö']
        ]
        
        for category in categories_data:
            categories_ws.append(category)
        
        # –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ª–∏—Å—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        for col in range(1, 5):
            cell = categories_ws.cell(row=1, column=col)
            cell.font = Font(bold=True, color="FFFFFF")
            cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        
        # –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫
        for ws in wb.worksheets:
            for column in ws.columns:
                max_length = 0
                column_letter = column[0].column_letter
                for cell in column:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = min(max_length + 2, 50)
                ws.column_dimensions[column_letter].width = adjusted_width
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–π—Ç—ã
        output = io.BytesIO()
        wb.save(output)
        output.seek(0)
        return output.getvalue()
    
    def create_prices_template(self) -> bytes:
        """–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω Excel —Ñ–∞–π–ª–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω"""
        wb = Workbook()
        ws = wb.active
        ws.title = "–¶–µ–Ω—ã"
        
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏
        headers = [
            'SKU —Ç–æ–≤–∞—Ä–∞*', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '–ù–æ–≤–∞—è —Ü–µ–Ω–∞*', '–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞', '–í–∞–ª—é—Ç–∞'
        ]
        
        # –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = Font(bold=True, color="FFFFFF")
            cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
            cell.alignment = Alignment(horizontal="center", vertical="center")
        
        # –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö
        examples = [
            ['IPHONE16Pro-256GB-TitaniumNatural', 'iPhone 16 Pro 256GB Titanium Natural', 89990, 99990, 'RUB'],
            ['MACBOOKProM3-512GB-Silver', 'MacBook Pro M3 512GB Silver', 199990, 219990, 'RUB']
        ]
        
        for row, example in enumerate(examples, 2):
            for col, value in enumerate(example, 1):
                ws.cell(row=row, column=col, value=value)
        
        # –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫
        for column in ws.columns:
            max_length = 0
            column_letter = column[0].column_letter
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = min(max_length + 2, 50)
            ws.column_dimensions[column_letter].width = adjusted_width
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–π—Ç—ã
        output = io.BytesIO()
        wb.save(output)
        output.seek(0)
        return output.getvalue()
    
    def parse_products_excel(self, file_content: bytes) -> List[Dict[str, Any]]:
        """–ü–∞—Ä—Å–∏—Ç—å Excel —Ñ–∞–π–ª —Å —Ç–æ–≤–∞—Ä–∞–º–∏"""
        try:
            # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
            df = pd.read_excel(io.BytesIO(file_content), sheet_name='–¢–æ–≤–∞—Ä—ã')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
            required_columns = ['–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞*', '–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (level0)*', '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (level1)*', '–î–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (level2)*', '–¶–µ–Ω–∞*']
            missing_columns = [col for col in required_columns if col not in df.columns]
            if missing_columns:
                raise ValueError(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {', '.join(missing_columns)}")
            
            products = []
            errors = []
            
            for index, row in df.iterrows():
                try:
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è)
                    if (pd.isna(row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞*']) or 
                        pd.isna(row['–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (level0)*']) or 
                        pd.isna(row['–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (level1)*']) or 
                        pd.isna(row['–î–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (level2)*']) or 
                        pd.isna(row['–¶–µ–Ω–∞*'])):
                        continue
                    
                    # –ü–∞—Ä—Å–∏–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                    specifications = {}
                    if not pd.isna(row.get('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (JSON)', '')):
                        try:
                            specifications = json.loads(str(row['–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (JSON)']))
                        except json.JSONDecodeError:
                            specifications = {}
                    
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–æ–ª—è –∏–∑ specifications –∏–ª–∏ –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                    color = specifications.get('color', '') if specifications else ''
                    disk = specifications.get('disk', specifications.get('memory', '')) if specifications else ''
                    ram = specifications.get('ram', '') if specifications else ''
                    sim_config = specifications.get('sim_config', specifications.get('sim_type', '')) if specifications else ''
                    
                    product = {
                        'sku': str(row.get('SKU —Ç–æ–≤–∞—Ä–∞', '')).strip() if not pd.isna(row.get('SKU —Ç–æ–≤–∞—Ä–∞', '')) else '',
                        'name': str(row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞*']).strip(),
                        'description': str(row.get('–û–ø–∏—Å–∞–Ω–∏–µ', '')).strip() if not pd.isna(row.get('–û–ø–∏—Å–∞–Ω–∏–µ', '')) else '',
                        'level0': str(row['–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (level0)*']).strip(),
                        'level1': str(row['–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (level1)*']).strip(),
                        'level2': str(row['–î–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (level2)*']).strip(),
                        'brand': str(row.get('–ë—Ä–µ–Ω–¥', '')).strip() if not pd.isna(row.get('–ë—Ä–µ–Ω–¥', '')) else '',
                        'price': float(row['–¶–µ–Ω–∞*']),
                        'currency': str(row.get('–í–∞–ª—é—Ç–∞', 'RUB')).strip().upper() if not pd.isna(row.get('–í–∞–ª—é—Ç–∞', 'RUB')) else 'RUB',
                        'stock': int(row.get('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ', 0)) if not pd.isna(row.get('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ', 0)) else 0,
                        'image_url': str(row.get('URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)', '')).strip() if not pd.isna(row.get('URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)', '')) else '',
                        'specifications': specifications,
                        'color': color,
                        'disk': disk,
                        'ram': ram,
                        'sim_config': sim_config
                    }
                    
                    products.append(product)
                    
                except Exception as e:
                    errors.append(f"–°—Ç—Ä–æ–∫–∞ {index + 2}: {str(e)}")
            
            if errors:
                raise ValueError(f"–û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ: {'; '.join(errors)}")
            
            return products
            
        except Exception as e:
            raise ValueError(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: {str(e)}")
    
    def parse_prices_excel(self, file_content: bytes) -> List[Dict[str, Any]]:
        """–ü–∞—Ä—Å–∏—Ç—å Excel —Ñ–∞–π–ª —Å —Ü–µ–Ω–∞–º–∏"""
        try:
            # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
            df = pd.read_excel(io.BytesIO(file_content), sheet_name='–¶–µ–Ω—ã')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
            required_columns = ['SKU —Ç–æ–≤–∞—Ä–∞*', '–ù–æ–≤–∞—è —Ü–µ–Ω–∞*']
            missing_columns = [col for col in required_columns if col not in df.columns]
            if missing_columns:
                raise ValueError(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {', '.join(missing_columns)}")
            
            prices = []
            errors = []
            
            for index, row in df.iterrows():
                try:
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                    if pd.isna(row['SKU —Ç–æ–≤–∞—Ä–∞*']) or pd.isna(row['–ù–æ–≤–∞—è —Ü–µ–Ω–∞*']):
                        continue
                    
                    price_data = {
                        'sku': str(row['SKU —Ç–æ–≤–∞—Ä–∞*']).strip(),
                        'name': str(row.get('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '')).strip(),
                        'price': float(row['–ù–æ–≤–∞—è —Ü–µ–Ω–∞*']),
                        'old_price': float(row.get('–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞', row['–ù–æ–≤–∞—è —Ü–µ–Ω–∞*'])),
                        'currency': str(row.get('–í–∞–ª—é—Ç–∞', 'RUB')).strip().upper()
                    }
                    
                    prices.append(price_data)
                    
                except Exception as e:
                    errors.append(f"–°—Ç—Ä–æ–∫–∞ {index + 2}: {str(e)}")
            
            if errors:
                raise ValueError(f"–û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ: {'; '.join(errors)}")
            
            return prices
            
        except Exception as e:
            raise ValueError(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: {str(e)}")
    
    def parse_images_excel(self, file_content: bytes) -> List[Dict[str, Any]]:
        """–ü–∞—Ä—Å–∏—Ç—å Excel —Ñ–∞–π–ª —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏"""
        try:
            # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
            df = pd.read_excel(io.BytesIO(file_content), sheet_name='–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
            required_columns = ['–ú–æ–¥–µ–ª—å (level_2)*', '–¶–≤–µ—Ç*', 'URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)*']
            missing_columns = [col for col in required_columns if col not in df.columns]
            if missing_columns:
                raise ValueError(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {', '.join(missing_columns)}")
            
            images = []
            errors = []
            
            for index, row in df.iterrows():
                try:
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                    if pd.isna(row['–ú–æ–¥–µ–ª—å (level_2)*']) or pd.isna(row['–¶–≤–µ—Ç*']) or pd.isna(row['URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)*']):
                        continue
                    
                    # –ü–∞—Ä—Å–∏–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                    image_urls_str = str(row['URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)*']).strip()
                    if not image_urls_str:
                        continue
                    
                    # –†–∞–∑–¥–µ–ª—è–µ–º URL –ø–æ –∑–∞–ø—è—Ç–æ–π –∏ –æ—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
                    image_urls = [url.strip() for url in image_urls_str.split(',') if url.strip()]
                    
                    if not image_urls:
                        continue
                    
                    image_data = {
                        'level_2': str(row['–ú–æ–¥–µ–ª—å (level_2)*']).strip(),
                        'color': str(row['–¶–≤–µ—Ç*']).strip(),
                        'img_list': image_urls
                    }
                    
                    images.append(image_data)
                    
                except Exception as e:
                    errors.append(f"–°—Ç—Ä–æ–∫–∞ {index + 2}: {str(e)}")
            
            if errors:
                raise ValueError(f"–û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ: {'; '.join(errors)}")
            
            return images
            
        except Exception as e:
            raise ValueError(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: {str(e)}")
    
    def export_products_to_excel(self, products: List[Dict[str, Any]]) -> bytes:
        """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ Excel —Ñ–∞–π–ª"""
        wb = Workbook()
        ws = wb.active
        ws.title = "–¢–æ–≤–∞—Ä—ã"
        
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏
        headers = [
            'ID', 'SKU', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–£—Ä–æ–≤–µ–Ω—å 0', '–£—Ä–æ–≤–µ–Ω—å 1', '–£—Ä–æ–≤–µ–Ω—å 2', '–ë—Ä–µ–Ω–¥',
            '–¶–µ–Ω–∞', '–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞', '–í–∞–ª—é—Ç–∞', '–°–∫–∏–¥–∫–∞ %', '–ù–∞ —Å–∫–ª–∞–¥–µ', '–î–æ—Å—Ç—É–ø–µ–Ω', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', '–ö–æ–ª-–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è'
        ]
        
        # –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = Font(bold=True, color="FFFFFF")
            cell.fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
            cell.alignment = Alignment(horizontal="center", vertical="center")
        
        # –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        for row, product in enumerate(products, 2):
            ws.cell(row=row, column=1, value=product.get('id'))
            ws.cell(row=row, column=2, value=product.get('sku'))
            ws.cell(row=row, column=3, value=product.get('name'))
            ws.cell(row=row, column=4, value=product.get('category_name'))
            ws.cell(row=row, column=5, value=product.get('level0'))
            ws.cell(row=row, column=6, value=product.get('level1'))
            ws.cell(row=row, column=7, value=product.get('level2'))
            ws.cell(row=row, column=8, value=product.get('brand'))
            ws.cell(row=row, column=9, value=product.get('price'))
            ws.cell(row=row, column=10, value=product.get('old_price'))
            ws.cell(row=row, column=11, value=product.get('currency'))
            ws.cell(row=row, column=12, value=product.get('discount_percentage'))
            ws.cell(row=row, column=13, value=product.get('stock'))
            ws.cell(row=row, column=14, value=product.get('is_available'))
            ws.cell(row=row, column=15, value=product.get('image_text'))
            ws.cell(row=row, column=16, value=product.get('images_count'))
            ws.cell(row=row, column=17, value=product.get('created_at'))
        
        # –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫
        for column in ws.columns:
            max_length = 0
            column_letter = column[0].column_letter
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = min(max_length + 2, 50)
            ws.column_dimensions[column_letter].width = adjusted_width
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–π—Ç—ã
        output = io.BytesIO()
        wb.save(output)
        output.seek(0)
        return output.getvalue()
